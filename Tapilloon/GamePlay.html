<!doctype html>
<html>
<head>
<meta charset="utf8">
<title>Socket.IO CharMove</title>
<style>
  #char{
    position: relative;
    top:500px;
    left: 500px;
    width: 10px;
    height: 10px;
  }
</style>
</head>
<body id="Play">

<img id="char" src="/image/Balloon_Heart.png">

<script src="/socket.io/socket.io.js"></script>

<script>
let header_pages = document.getElementById('char');

let size = 100;
header_pages.style.width = size + "px";
header_pages.style.height = size + "px";

window.onload = () => {
  const socket = io();
  const token = getToken();

  //----------------------------------
  // サーバにイベントを送信
  //----------------------------------
  document.querySelector("body").addEventListener("keypress", (e)=>{
    let keycd = e.keyCode;

    // ToDo: 自分の画面ではキャラを動かす
    moveChar(keycd);

    // ToDo: サーバに次の情報を送信する。
    //   - 自分自身を判別するToken
    //   - どのキーを押したか
    socket.emit('movechar',{token:token, key:keycd});
  });

  //----------------------------------
  // サーバからイベントを受信
  //----------------------------------
  socket.on('movechar', (data)=>{
    //ToDo: 自分以外のユーザーが操作したならキャラクターを動かす
    if(token !== data.token){
      moveChar(data.key);
    }
  });
}

/**
 * キャラを移動する関数
 */
 function moveChar(keycd){
  const element = document.querySelector("#char");
  const step = 80;

  // キャラの現在位置を取得
  const pos = getPosition(element);

  // アニメーション時間を指定
  element.style.transition = '0.5s';

  const Changesize = 50.0;

  const size = getSize(element);

  // キャラを移動させる
  switch(keycd){
    case 119:  //W ↑
      element.style.transform = `translate(${pos.x}px,${pos.y-step}px)`;
      break;
    case 97:   //A ←
      element.style.transform = `translate(${pos.x-step}px,${pos.y}px)`;
      break;
    case 115:  //S ↓
      element.style.transform = `translate(${pos.x}px,${pos.y+step}px)`;
      break;
    case 100:  //D →
      element.style.transform = `translate(${pos.x+step}px,${pos.y}px)`;
      break;
    case 32: //SPACE
    element.style.width = (size.x + Changesize) + "px";
    element.style.height  = (size.y + Changesize) + "px";
    break;
    default:
      console.log(keycd);
      break;
  }
  console.log(keycd);
}

/**
 * 指定オブジェクトの座標を返却する
 */
function getPosition(element){
  let rect = element.getBoundingClientRect();
  let body = document.querySelector("body").getBoundingClientRect();
  return({
      x: Math.ceil(rect.x - body.x)
    , y: Math.ceil(rect.y - body.y)
  });
}

function getSize(element)
{
  return({x: element.offsetHeight
         ,y: element.offsetWidth
       });
}


/**
 * ランダムな文字列を作成
 *
 * @param  {integer} len 文字列長
 * @return {string}
 */
 function getToken(len=32){
  const ls = "abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  let result = "";

  for(let i=0; i<len; i++){
    const idx = Math.floor( Math.random() * ls.length );
    result += ls[idx];
  }

  return(result);
}

</script>
</body>
</html>
